{% extends 'app.html' %}

{% load static %}

{% block title %}- Editar Pedido de Parecer{% endblock title %}

{% block content %}
<div id="editar-pedido">
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div style="padding: 1rem 2vw 0px;">
        <hr/>
        <h2 class="title has-text-grey is-uppercase" style="font-size: 2.0rem;">Editar Pedido de Parecer</h2>
        {% if msg %}
        <div  style="margin-left:30%;margin-right:30%; margin-top:0%">
            <div style="margin-top:2%;text-align: center;position:center;">
                <article class="message is-danger">
                    <div class="message-body">
                        <p style="text-align: center;">{{erros}}</p>
                    </div>
                </article>
            </div>
        </div> 
        {% endif %}
        <div style="margin-bottom: 1.5rem">
            <label for="assunto" style="display: block; font-weight: bold; margin-bottom: 0.5rem">Assunto:</label>
            <input type="text" id="assunto" name="assunto" value="{{form.assunto.value|default_if_none:""}}" style="font-size: 1rem; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;width: 100%;" required/>
        </div>
        <div class="columns">
            <div class="column">
                <div class="field">
                    <label class="label">Data Alvo:</label>
                    <div class="control is-clearfix">
                        <input name="data" value="{{form.data.value|default_if_none:""}}" type="date" class="input">
                    </div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 1.5rem">
            <label for="descricao" style="display: block; font-weight: bold; margin-bottom: 0.5rem">Descrição:</label>
            <textarea id="descricao" name="descricao"
              style="font-size: 1rem; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; width: 100%; min-height: 10rem;" required>{{form.descricao.value|default_if_none:""}}
            </textarea>
        </div>
        
        <div>&nbsp;</div>
        
        <table class="table" style="width: 100%; background-color: rgb(51, 151, 131);">
            <thead>
                <tr>
                    <th></th>
                    <th>Assunto</th>
                    <th>Descrição</th>
                    <th>Nome do Investigador</th>
                    <th>Ficheiro</th>
                </tr>
            </thead>
            <tbody style="background-color: #ccc;">
                <tr v-for="(subpedido, index) in subpedidos" :key="index">
                    <th>
                        <button type="button" class="button is-danger is-small" v-on:click="removeRow(index)">Remover</button>
                    </th>
                    <th style="font-weight: normal;"> [[subpedido.assunto]]</th>
                    <th style="font-weight: normal;"> [[subpedido.descricao]]</th>
                    <th style="font-weight: normal;"> [[subpedido.nome_investigador]]</th>
                    <th style="font-weight: normal"></th>
                </tr>
            </tbody>
        </table>
        
        <add-subpedido :subpedidos="subpedidos"></add-subpedido>
    </div>
    
    <div>&nbsp;</div>
    
    <input type="hidden" name="subpedidos" v-bind:value="JSON.stringify(subpedidos)">
    <div style="margin-top:8%;text-align:center;position:center;">
        <button type="button" value="Voltar" class="button is-outlined" style="margin-right:5%" onclick="history.back();" >Voltar</button>
        <button name="confirmar" value="confirmado" class="button is-success is-outlined" v-on:click="confirmar()"><span>Confirmar</span></button>            
    </div>
</form>
</div>

{% endblock content %}

{% block scripts %}
<script>    
    axios.defaults.xsrfCookieName = 'csrftoken';
    axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
    Vue.component('add-subpedido', {
        delimiters: ["[[", "]]"],
        props: ['subpedidos'],
        template: ` 
        <div>
            <div>                 
                <article v-if="valueError" class="message is-danger">
                    <div class="message-body">
                        <p style="text-align: center;">
                            O assunto e a descrição deve ter pelo menos 5 caracteres
                        </p>
                    </div>
                </article>
                <table class="table" style="width: 100%;">
                    <tbody>
                        <tr>
                            <td>
                                <input type="text" style="font-size: 1rem; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; width: 100%;" placeholder="Assunto" v-model="subassunto" >
                            </td>
                            <td>
                                <textarea v-model="subdescricao" style="font-size: 1rem; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; width: 100%; min-height: 1rem;" placeholder="Descrição"></textarea>
                            </td>
                            <td>
                                <input type="text" style="font-size: 1rem; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; width: 100%;" placeholder="Investigador" v-model="subinvestigador" >
                            </td>
                            <td colspan="3">
                                <input type="file" :name="'file' + index">
                            </td>
                        </tr>
                    </tbody>
                </table>
                <button style="margin-left: 50%;" type="button" class="button is-success" v-on:click="addRow()">Adicionar</button>                           
            </div>
        </div>
        `,
        data() {
        return{
            error: false,
            subacoes: "",
            subassunto: "",
            subdescricao: "",
            subinvestigador: "",
            file: null
        };
    },
    computed: {
        valueError(){
            return this.error;
        }
    },
    methods: {
        clearInput(){
            this.subassunto = "";
            this.subdescricao = "";
            this.subinvestigador = "";
            this.file = null; // Reset the file as well
        },
        hasError1() {
            return  this.subassunto.length < 5 || this.subdescricao.length < 5 ;
        },

        handleFileUpload(event) {
            this.file = event.target.files[0]; // Set the file to the first file in the input
        },
        addRow(){
            if(!this.hasError1()) {
                const novoSubpedido = {
                    assunto: this.subassunto,
                    descricao: this.subdescricao,
                    nome_investigador: this.subinvestigador,
                };
                this.subpedidos.push(novoSubpedido);
                console.log(this.subpedidos);
                this.clearInput();
                this.error = false;
            }
            else {
                this.error = true;
            }
        },
    },
 });
 var app = new Vue({
    delimiters: ["[[", "]]"],
    el: '#editar-pedido',
    data(){
        return{
            subpedidos: [],
            selectedOption: '',
            showFileBox: '',
        }
    },
    mounted(){
        var a = "{{pedidos}}";
        this.getSubPedidos(a);
        var b = "{{tipo}}";
        this.setSelectOption(b);
        this.show();
    },
    methods: {
        removeRow(index){
            this.subpedidos.splice(index, 1);
        },
        setSelectOption(a){
            this.selectedOption = a
        },
        show(){
            if (this.selectedOption == 1)
                this.showFileBox = 1
            else    
                this.showFileBox = 2
        },
        getSubPedidos(subpedidos){
            if(subpedidos.length > 0){
                let arrayValores = subpedidos.split("&#x27;");
                console.log(arrayValores);
                for (let i = 3; i < arrayValores.length; i += 18){
                    const novoSubpedido = {
                        assunto: arrayValores[i],
                        descricao: arrayValores[i+4],
                        nome_investigador: arrayValores[i+8],
                        file_exists: arrayValores[i+11],
                        file_url: arrayValores[i+14],
                    };
                    this.subpedidos.push(novoSubpedido);
                }
            }
           
        }
        
    },
    computed: {
        change(){
            this.showFileBox = 1
        }
    }
  });
    
</script>
{% endblock scripts %}